name: Deploy Drive Webhook → Cloud Run

on:
  push:
    paths:
      - 'server/**'
      - '.github/workflows/deploy.yml'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    # 1) Authenticate to GCP using your service‐account JSON
    - uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    # 2) Install the gcloud SDK and set your project
    - uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT }}   # no service_account_key here!

    # 3) Deploy to Cloud Run
    - run: |
        gcloud run deploy hti-drive-webhook \
          --source=server \
          --region=us-central1 \
          --platform=managed \
          --allow-unauthenticated \
          --set-env-vars=INPUT_FOLDER_ID=${{ secrets.INPUT_FOLDER_ID }},OUTPUT_FOLDER_ID=${{ secrets.OUTPUT_FOLDER_ID }}
      shell: bash
